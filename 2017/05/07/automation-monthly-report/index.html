<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><title>OSS コントリビューションや GitHub 上のアクティビティのまとめレポート投稿を自動化する | blog.sugarshin.net</title><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="title" content="OSS コントリビューションや GitHub 上のアクティビティのまとめレポート投稿を自動化する | blog.sugarshin.net"/><meta name="author" content="sugarshin | Shingo Sato"/><meta name="description" content="月ごとに、 OSS コントリビューションや GitHub 上での活動をまとめたレポートの当ブログへの投稿を自動化しました。なかなかブログも書けないので、これから GitHub の月報を投稿していくことにしました。[Monthly report] 2017-04 my activi"/><meta property="og:title" content="OSS コントリビューションや GitHub 上のアクティビティのまとめレポート投稿を自動化する | blog.sugarshin.net"/><meta property="og:description" content="月ごとに、 OSS コントリビューションや GitHub 上での活動をまとめたレポートの当ブログへの投稿を自動化しました。なかなかブログも書けないので、これから GitHub の月報を投稿していくことにしました。[Monthly report] 2017-04 my activi"/><meta property="og:type" content="article"/><meta property="og:image" content="https://blog.sugarshin.net/assets/images/2017/05/07/automation-monthly-report/main.png"/><meta property="og:url" content="https://blog.sugarshin.net/2017/05/07/automation-monthly-report/"/><meta property="og:site_name" content="blog.sugarshin.net"/><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0 Feed" href="/rss.xml"/><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="manifest" href="/manifest.json"><link rel="shortcut icon" href="/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="apple-mobile-web-app-title" content="blog.sugarshin.net"><meta name="application-name" content="blog.sugarshin.net"><meta name="mobile-web-app-capable" content="yes"><meta name="msapplication-TileColor" content="#fff"><meta name="msapplication-TileImage" content="/mstile-144x144.png"><meta name="msapplication-config" content="/browserconfig.xml"><meta name="theme-color" content="#fff"><link href="/assets/vendor-4345b94853d12f0ea813.css" rel="stylesheet"><link href="/assets/app-c1317635a347d9991909.css" rel="stylesheet"></head><body><div style="display:none"><h1>OSS コントリビューションや GitHub 上のアクティビティのまとめレポート投稿を自動化する | blog.sugarshin.net</h1><div><p><img src="/assets/images/2017/05/07/automation-monthly-report/main.png" alt="Main"></p>
<p>月ごとに、 OSS コントリビューションや GitHub 上での活動をまとめたレポートの当ブログへの投稿を自動化しました。</p>
<hr>
<p>なかなかブログも書けないので、これから GitHub の月報を投稿していくことにしました。</p>
<p><a href="/2017/04/30/monthly-report-1704">[Monthly report] 2017-04 my activity this month on GitHub</a></p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#%E6%B5%81%E3%82%8C">流れ</a></li>
<li><a href="#list-events-performed-by-a-user">List events performed by a user</a></li>
<li><a href="#%E8%A8%98%E4%BA%8B%E4%BD%9C%E6%88%90">記事作成</a></li>
<li><a href="#%E3%83%93%E3%83%AB%E3%83%89">ビルド</a></li>
<li><a href="#%E5%AE%9A%E6%9C%9F%E5%AE%9F%E8%A1%8C">定期実行</a></li>
<li><a href="#%E3%83%AA%E3%83%B3%E3%82%AF">リンク</a></li>
</ul>
<h2 id="流れ">流れ</h2>
<p>やっていることは単純ですが大まかな流れとしては、</p>
<ol>
<li>GitHub API から User event を取得して該当月のイベントから記事を作成する</li>
<li>GitHub へ push</li>
<li>API で Pull request 作成 => CI がパス次第 API で Merge</li>
<li>CircleCI などで上述の script を実行</li>
<li>cron などで月末に定期ビルドさせる</li>
</ol>
<p>前提として、 GitHub 上で投稿までのサイクルが回るようになっています。</p>
<p><a href="/2016/07/14/blog-like-software-development">React と Redux なブログ運用をソフトウェア開発する話し</a></p>
<h2 id="list-events-performed-by-a-user">List events performed by a user</h2>
<p>User event は <code>GET /users/:username/events</code> エンドポイントから取得します。パブリックなイベントのみでいいはずなのでアクセストークンは必要ないです。</p>
<p>ただ API の仕様で、過去 90 日以内でかつ上限 300 件しか取得できないので、活動が多かった月は漏れがあるかもです。週ごと程度定期で取得してストックしておくなどの対応が必要かもですね。</p>
<p>ref: <a href="https://developer.github.com/v3/activity/events/#list-events-performed-by-a-user">https://developer.github.com/v3/activity/events/#list-events-performed-by-a-user</a></p>
<pre><code class="language-bash">$ curl "https://api.github.com/users/sugarshin/events"

[
  {
    "id": "5823717083",
    "type": "PushEvent",
    "actor": {
      "id": 2001452,
      "login": "sugarshin",
      "display_login": "sugarshin",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sugarshin",
      "avatar_url": "https://avatars.githubusercontent.com/u/2001452?"
    },
    "repo": {
      "id": 58251000,
      "name": "sugarshin/blog.sugarshin.net",
      "url": "https://api.github.com/repos/sugarshin/blog.sugarshin.net"
    },
    "payload": {
      "push_id": 1723998566,
      "size": 1,
      "distinct_size": 1,
      "ref": "refs/heads/gh-pages",
      "head": "2944a811f7f2c9f58b994ad46da1a7d67f1a5de8",
      "before": "21e6e15b34bad569fb2b2a6f233354ea38fdd69f",
      "commits": [
        {
          "sha": "2944a811f7f2c9f58b994ad46da1a7d67f1a5de8",
          "author": {
            "email": "s+travisci@sugarshin.net",
            "name": "Travis CI"
          },
          "message": "Updates",
          "distinct": true,
          "url": "https://api.github.com/repos/sugarshin/blog.sugarshin.net/commits/2944a811f7f2c9f58b994ad46da1a7d67f1a5de8"
        }
      ]
    },
    "public": true,
    "created_at": "2017-05-07T04:57:51Z"
  },
  ...
]
</code></pre>
<h2 id="記事作成">記事作成</h2>
<p>記事作成は取得したイベントデータを元にパース、フォーマットして Markdown ファイルとして書き出します。</p>
<p><a href="https://github.com/sugarshin/blog.sugarshin.net/blob/6370f753134c3ba9592afd7cac5c7640746a060e/scripts/create-monthly-report/index.js">blog.sugarshin.net/scripts/create-monthly-report/index.js</a></p>
<p>対象のイベントは現状、下記に絞ってあります。</p>
<ul>
<li><code>CreateEvent</code></li>
<li><code>PullRequestEvent</code></li>
<li><code>PublicEvent</code></li>
<li><code>WatchEvent</code></li>
<li><code>IssuesEvent</code></li>
</ul>
<p>イベントタイプは<a href="https://developer.github.com/v3/activity/events/types/">ドキュメント</a>にまとまっています。</p>
<p>ここから Markdown として出力するのに少しフィルタリングしています。</p>
<h2 id="ビルド">ビルド</h2>
<p>ビルドは CircleCI 上で行います。</p>
<p>ブログのリポジトリだけで完結させられるかと思いましたが、ごちゃごちゃしそうだったので別環境を用意しています。</p>
<p><a href="https://github.com/sugarshin/build.blog.sugarshin.net">https://github.com/sugarshin/build.blog.sugarshin.net</a></p>
<p>現状、 Pull request のマージは、ステータスが <code>mergeable</code> かつ <code>mergeable_state === 'clean'</code> になるまでポーリングしています。ステータス変更をトリガーできればいいですね。</p>
<ul>
<li><a href="https://github.com/sugarshin/build.blog.sugarshin.net/blob/42bf302cb92cfffccbc98b30339906dc5c4cbf15/merge-pull-request.js#L36">build.blog.sugarshin.net/merge-pull-request.js at 42bf302cb92cfffccbc98b30339906dc5c4cbf15 · sugarshin/build.blog.sugarshin.net</a></li>
</ul>
<p>CircleCI の API からビルドを実行します。</p>
<p>ref: <a href="https://circleci.com/docs/api/v1-reference/#recent-builds-project-branch">Recent Builds For a Project Branch - CircleCI API v1.1 Reference - CircleCI</a></p>
<pre><code class="language-bash">$ curl -XPOST "https://circleci.com/api/v1/project/sugarshin/build.blog.sugarshin.net/tree/monthly-report?circle-token=$TOKEN"
</code></pre>
<h2 id="定期実行">定期実行</h2>
<p>月末に定期実行させるために、 cron などで上述 CircleCI の API を叩きます。</p>
<p>今回は既存の自分のプライベート Hubot 内で起動させてあります。</p>
<pre><code class="language-coffeescript"># Description:
#   monthly report to blog

{ CronJob } = require 'cron'
fetch = require 'node-fetch'

{ HUBOT_BLOG_BUILDER_CIRCLE_TOKEN: TOKEN } = process.env

module.exports = () ->
  executeMonthlyReport = ->
    fetch(
      "https://circleci.com/api/v1/project/sugarshin/build.blog.sugarshin.net/tree/monthly-report?circle-token=#{TOKEN}"
      method: 'POST'
    )

  new CronJob('0 01 00 01 * *', executeMonthlyReport).start()
</code></pre>
<p>月の末日をとるのが難しかったので、月初の 0 時 1 分とし、そこからビルド時間を考慮した分をマイナスして計算するようにしてあります。</p>
<p>ref: <a href="https://github.com/sugarshin/blog.sugarshin.net/blob/53700e705c6f154510d853fa5cbdd5f393a376ce/scripts/create-monthly-report/index.js#L42">blog.sugarshin.net/index.js at 53700e705c6f154510d853fa5cbdd5f393a376ce · sugarshin/blog.sugarshin.net</a></p>
<hr>
<p>GitHub の API でとれるデータを元に、エンジニアのパフォーマンス計測や作業量などの算出に利用して、エンジニアの働き方やワークライフバランス改善の 1 つの指針に利用できたりしないかなと考えてみたりしています。</p>
<h2 id="リンク">リンク</h2>
<ul>
<li><a href="https://blog.sugarshin.net/">https://blog.sugarshin.net/</a></li>
<li><a href="https://github.com/sugarshin/blog.sugarshin.net">https://github.com/sugarshin/blog.sugarshin.net</a></li>
<li><a href="https://github.com/sugarshin/build.blog.sugarshin.net">https://github.com/sugarshin/build.blog.sugarshin.net</a></li>
</ul></div></div><div id="app-root"></div><script type="text/javascript" src="/assets/vendor-0b78b2956188e2da500d.js"></script><script type="text/javascript" src="/assets/app-49e4ccfdf87ee7427ac4.js"></script></body></html>